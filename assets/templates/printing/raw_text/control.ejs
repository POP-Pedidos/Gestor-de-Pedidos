<!DOCTYPE html>
<html paper_size="<%= printer?.size || 58 %>">

<head>
    <style>
        * {
            box-sizing: border-box;
        }

        @page {
            margin: 0;
        }

        @media print {
            body {
                margin: 0;
            }
        }

        @media not print {
            html {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                background: rgb(32, 32, 32);
            }
        }

        html[paper_size="58"] {
            width: 49mm;
        }

        html[paper_size="80"] {
            width: 80mm;
        }

        body {
            background: white;
            margin: 0;
            display: inline-block;
            font-family: monospace, sans-serif;
            font-weight: bold;
            width: 100%;
            padding: 5px;
            font-size: 11.6px;
        }

        pre {
            margin: 0;
            white-space: pre-wrap;
        }
    </style>
    <title>Via de controle (<%= order.order_company_sequence %>)</title>
</head>

<html>

<body>
<%
    let lines = [];

    lines.push(CenterText("VIA DE CONTROLE", 41));

    lines.push("");

    lines.push(`PEDIDO: ${order.order_company_sequence}`);
    lines.push(`CLIENTE: ${NormalizeText(order.name_client)}`);
    lines.push(`TELEFONE: ${order.phone_client}`);

    lines.push("");

    lines.push(CenterText("ITENS", 41, "="));

    for(const item of order.items) {
        lines.push(`${item.quantity} x ${item.product.name} = ${MoneyFormat(item.price * item.quantity, false)}`);

        const total_flavors=item.pizza_flavors?.reduce((accumulator, flavor)=> accumulator + flavor.quantity, 0); 

        if(!!total_flavors?.length) { 
            lines.push(` ↳ Sabores`);
            
            for(const flavor of item.pizza_flavors) {
                const quantity = item.pizza_flavors.length> 1 ? `${flavor.quantity}/${total_flavors}` : `${(company.multiply_complements ? flavor.quantity * item.quantity : flavor.quantity) || 1} x`;

                lines.push(`    ↳ ${quantity} ${flavor.name} = ${MoneyFormat(flavor.price, false)}`);
            } 
        }

        for (const complement of item.complements || []) {
            lines.push(` ↳ ${NormalizeText(complement.name.toUpperCase())}`);

            for (const complement_item of complement.items || []) {
                const quantity = `${complement.required===false ? "+ " : "" }${(company.multiply_complements ? complement_item.quantity * item.quantity : complement_item.quantity) || 1}x`;

                lines.push(`    ↳ ${quantity} ${complement_item.name} = ${MoneyFormat(complement_item.price * complement_item.quantity, false)}`);
            }
        }

        if(item.observation) lines.push(` • ${item.observation}`);
    } 

    lines.push("");

    lines.push(`SUBTOTAL: ${MoneyFormat(order.subtotal, false)}`);
    lines.push(`TAXA DE ENTREGA: ${MoneyFormat(order.delivery_cost, false)}`);
    lines.push(`DESCONTO: ${MoneyFormat(order.discount + order.coupon_discount, false)}`);
    lines.push(`TOTAL: ${MoneyFormat(order.total, false)}`);

    lines.push(CenterText("", 41, "="));

    lines.push("");

    if(order.delivery_type !="withdrawal") {
        lines.push(`ENDEREÇO: ${NormalizeText(`${order.street_name}, ${order.street_number} - ${order.neighborhood}, ${order.city} - ${order.state}`)}`);

        if(!!order.reference) lines.push(`REFERENCIA: ${NormalizeText(order.reference)}`);
        if(!!order.complement) lines.push(`COMPLEMENTO: ${NormalizeText(order.complement)}`);
    } else {
        lines.push(`TIPO: Retirada`);
    }

    lines.push(`FORMA DE PAGTO: ${TranslatePaymentMethod(order.payment_method)}`);
    if(order.cash_change > 0) lines.push(`TROCO: ${MoneyFormat(order.cash_change - order.total)}`);
    if(!!order.observation) lines.push(`OBS: ${order.observation}`);

    lines.push(`DATA PEDIDO: ${new Date(order.createdAt).toLocaleString()}`);
    lines.push(`DATA IMPRESAO: ${new Date().toLocaleString()}`);
%>
<pre><%- lines.join("\n") %></pre>
</body>

</html>